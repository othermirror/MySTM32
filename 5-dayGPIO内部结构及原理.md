# GPIO应用举例

### LED灯

> CPU往对应的引脚去设置电平状态（写1/0），导致LED灯亮起

### KEY按键

> CPU读取对应引脚的电平状态，进行判断按键是否按下



***

# GPIO引脚

### 1、什么是GPIO引脚

- 就是从芯片内部引出的一根复用的口线
- 可以由CPU配置成不同的功能（输入、输出、其他复用功能等）
- STM32F4xx共有144个GPIO引脚，分为9组，每组管理16根引脚
- 每组管理的16根引脚进行编号0~15，所以GPIOF5可以简写为PF5，其他同理



***

# STM32F4xx GPIO内部结构及其原理

- 每个GPIO口内部都可以配置成以下功能
  - 输入功能
    - 输入悬空：既不接上拉电阻也不接下拉电阻，引脚电平完全由外部控制
    - 带上拉输入：内部接上拉电阻，外部悬空时CPU读取为高电平
    - 带下拉输入：内部接下拉电阻，外部悬空时CPU读取为低电平
    - 模拟输入：当此模式时，能获取外部的模拟信号，通过芯片内部ADC转换为数字量
  - 输出功能
    - 输出推挽：
      - 输出端输出高电平时，上方P-MOS导通，下方的N-MOS截止，电流由基极和集电极推向发射极，引脚为高电平
      - 输出端输出低电平时，上方P-MOS截止，下方的N-MOS导通，电流由发射极流向基极和集电极，引脚为低电平
      - 特点：能响应高电平输出高电平，响应低电平输出低电平
    - 输出开漏：
      - 只采用了下面的N-MOS，输出高电平时，引脚处于悬空状态
      - 输出低电平时，N-MOS导通，引脚处于低电平状态
      - 如果想要输出高电平，则外部引脚需要上拉电阻
  - 复用功能
    - 复用功能是指GPIO引脚作为其他功能口线，如：TIM、USART、SPI等
    - 每个GPIO口都可以配置为多达16中复用功能，记为AF0、AF1、AF2等
    - 不能随意的配置复用功能，具体配置成什么功能需要结合原理图，每个GPIO口可以配置的复用的功能早就已经设定好了



***

# STM32F4xx GPIO寄存器说明

> 具体可以参考[参考手册](./data/STM32F4xx中文参考手册.pdf)第七章
>
> 每个通用的io端口包括：
>
> ​	4个32位 配置寄存器（MODER、OTYPER、OSPEEDR、PUPDR）
>
> ​	2个32位 数据寄存器（IDR、ODR）
>
> ​	1个32位 置为/复位寄存器（BSRR）
>
> ​	1个32位 锁定寄存器（LCKR）
>
> ​	2个32位 复用功能寄存器（AFRH、AFRl）
>
> 以下分析每一个寄存器

### 1、GPIOx_MODER 模式选择寄存器

- 寄存器偏移地址为0x00
- ==作用：==用来配置GPIO的功能的
- 每个口占2bits （2x和2x+1 bit）
- **00 输入(复位状态)模式、01 通用模式、10 复用功能模式、11 模拟模式**

### 2、GPIOx_OTYPER 输出类型寄存器

- 寄存器偏移地址为0x04
- ==作用：==设置输出的模式
- 每个口占1 bit（x bit）
- **0 输出推挽、1 输出开漏**

### 3、GPIOx_OSPEEDR 端口输出速度寄存器

- 寄存器偏移地址为0x08
- ==作用：==用来控制输出的速率
- 每个口占2bis（2x和2x+1 bit）
- **00 2MHz低速、01 25MHz中速、10 50MHz快速、11 30pF为100 MHz，15pF为80 MHz高速**

### 4、GPIO_PUPDR 端口上拉/下拉寄存器

- 寄存器偏移地址为0x0C
- ==作用：==用来控制内部上拉下拉电阻的选择
- 每个口占2bits（2x和2x+1）
- **00 无上拉和下拉、01 上拉、10 下拉、11 保留位**

### 5、GPIOx_IDR 端口输入数据寄存器

> 只读，CPU可以读取这里来获取按键的输入情况

- 寄存器偏移地址为0x10
- ==作用：==用来存储输入的情况
- 只用到低16位的口，因为每组只有16根GPIO引脚

### 6、GPIOx_ODR 端口输出数据寄存器

> 读写，CPU可以在这写入数据来操作引脚的输出

- 寄存器偏移地址为0x14
- ==作用：==用来接受CPU输出的情况
- 只用到低16位的口，因为每组只有16根GPIO引脚

### 7、GPIOx_BSRR 端口置位/复位寄存器

- 间接操作ODR
- 寄存器偏移地址为0x18
- ==作用：==将相应的bit位置为1或者0
- 高16位为BRx，复位bit位，1 可以将相应的ODRx位复位0，0 不会有任何操作
- 低16位为BSx，置位bit位， 1 可以将相应的ODRx位置位1，0 不会有任何操作
- **置位的优先级高于复位的优先级**

### 8、 GPIOx_LCKR 端口配置锁定寄存器

- 寄存器偏移地址为0x1C 

- 如果是一个LOCK的状态，该GPIO引脚的配置就不能再修改了，如果一定要修改，必须要先 UNLOCK

- 第16bit：锁定键 ，可随时读取此位。可使用锁定键写序列对其进行修改。

  - 0：端口配置锁定键未激活
  - 1：端口配置锁定键已激活。直到 MCU 复位时，才锁定 GPIOx_LCKR 寄存器。

- 在锁定键写序列期间，不能更改 LCK[15:0] 的值

- 锁定序列中的任何错误都将中止锁定操作

- 锁定键写序列

  - ~~~C
    锁定键写序列：
    					WR LCKR[16] = ‘1’ + LCKR[15:0]
    					WR LCKR[16] = ‘0’ + LCKR[15:0]
    					WR LCKR[16] = ‘1’ + LCKR[15:0]
    					RD LCKR
    					RD LCKR[16] = ‘1’（此读操作为可选操作，但它可确认锁定已激活）
    ~~~

- 

### 9、GPIOx_AFRL GPIOx_AFRH  复位功能寄存器

- 寄存器偏移地址分别为0x20 、0x24 
- 因为每个GPIO接口最多可以有16个复用功能，所以用两个寄存器来保存
- GPIOx_AFRL ：GPIOx的引脚编号为 0 ~ 7 
- GPIOx_AFRH：GPIOx的引脚编号为 8 ~ 15



***

# 写程序的顺序

- 要用到哪个口就要给相对应的那个组==使能时钟==
- 一般是先进行清零操作，再进行赋值操作

